<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LightFix DB</title>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0c0e14;--surface:#14161e;--surface2:#1a1c26;
      --border:#1e2030;--border2:#252730;
      --accent:#f0c040;--accent-dim:#1e1a08;
      --text:#e0e0e0;--text-mid:#aaa;--text-dim:#666;
      --green:#3a3;--red:#c06060;
      --header-bg:#090b10;
    }
    /* LIGHT MODE */
    body.light{
      --bg:#f4f5f8;--surface:#ffffff;--surface2:#eef0f5;
      --border:#dde0ea;--border2:#cdd0dc;
      --accent:#b8920a;--accent-dim:#fdf4d0;
      --text:#1a1c26;--text-mid:#555;--text-dim:#888;
      --green:#2a7a2a;--red:#c03030;
      --header-bg:#ffffff;
    }
    body{background:var(--bg);color:var(--text);font-family:Georgia,'Times New Roman',serif;min-height:100vh;transition:background .2s,color .2s}
    a{color:#6ab0f5}
    body.light a{color:#1a6abf}

    /* HEADER */
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:var(--header-bg);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;transition:background .2s}
    #logo-btn{background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:10px;font-family:Georgia,serif;font-size:19px;font-weight:bold;color:var(--accent);letter-spacing:.5px}
    .header-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    #sync-badge{font-size:12px;color:#888;background:var(--surface2);padding:4px 10px;border-radius:12px;display:none}
    #no-sheet-badge{font-size:12px;color:var(--red);background:var(--surface);border:1px solid var(--border2);padding:4px 10px;border-radius:12px;cursor:pointer;display:none}
    /* kbd shortcut hint */
    .kbd-hint{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border2);border-radius:10px;padding:10px 18px;font-size:12px;color:var(--text-dim);z-index:500;display:none;gap:16px;flex-wrap:wrap;justify-content:center;box-shadow:0 4px 20px rgba(0,0,0,.4)}
    .kbd-hint.visible{display:flex}
    .kbd-hint kbd{background:var(--surface);border:1px solid var(--border2);border-radius:4px;padding:1px 6px;font-family:monospace;font-size:11px;color:var(--text-mid)}

    /* BUTTONS */
    .btn-primary{background:var(--accent);color:#0c0e14;border:none;padding:9px 18px;border-radius:6px;font-weight:bold;cursor:pointer;font-family:Georgia,serif;font-size:14px}
    .btn-secondary{background:transparent;color:var(--text-mid);border:1px solid #333;padding:9px 18px;border-radius:6px;cursor:pointer;font-family:Georgia,serif;font-size:14px}
    .btn-ghost{background:none;border:none;cursor:pointer;font-size:18px;color:#888;padding:6px 8px;line-height:1}
    .btn-refresh{background:none;border:1px solid #2a2a3a;color:#888;padding:7px 12px;border-radius:6px;cursor:pointer;font-size:15px}
    .btn-back{background:none;border:none;color:var(--accent);cursor:pointer;font-family:Georgia,serif;font-size:13px;margin-bottom:18px;padding:0}
    .btn-edit{background:#1a1c26;border:1px solid #2a2a3a;color:var(--accent);padding:7px 13px;border-radius:6px;cursor:pointer;font-family:Georgia,serif;font-size:13px}
    .btn-delete{background:#1a1010;border:1px solid #3a2020;color:var(--red);padding:7px 11px;border-radius:6px;cursor:pointer;font-size:13px}
    .btn-print{background:#1a1c26;border:1px solid #2a2a3a;color:#aaa;padding:7px 11px;border-radius:6px;cursor:pointer;font-size:13px}
    .btn-add-step{background:none;border:1px dashed #333;color:#777;padding:7px 14px;border-radius:6px;cursor:pointer;font-family:Georgia,serif;font-size:13px;align-self:flex-start;margin-top:4px}
    .btn-inline{background:none;border:none;color:var(--accent);cursor:pointer;text-decoration:underline;font-family:Georgia,serif;font-size:inherit}
    .btn-connect{background:var(--accent);color:#0c0e14;border:none;padding:11px 20px;border-radius:7px;font-weight:bold;cursor:pointer;font-family:Georgia,serif;white-space:nowrap}
    .step-remove{background:none;border:1px solid #333;color:#666;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:11px;flex-shrink:0}
    .btn-tab{background:none;border:none;color:var(--text-mid);padding:8px 16px;cursor:pointer;font-family:Georgia,serif;font-size:14px;border-bottom:2px solid transparent;transition:all .15s}
    .btn-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

    /* MAIN */
    main{max-width:940px;margin:0 auto;padding:20px 14px}
    .view{display:none}.view.active{display:block}

    /* MODALS */
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:300;align-items:center;justify-content:center;padding:16px}
    .modal-overlay.open{display:flex}
    .modal-card{background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:32px 28px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;position:relative}
    .modal-close{position:absolute;top:14px;right:16px;background:none;border:none;color:#666;font-size:20px;cursor:pointer;line-height:1}
    .modal-title{font-size:20px;color:var(--accent);margin-bottom:6px}
    .modal-sub{color:#777;font-size:13px;margin-bottom:20px}
    .connected-row{display:flex;align-items:center;gap:8px;background:#0e1f10;border:1px solid #2a4a2a;border-radius:8px;padding:10px 14px;margin-bottom:20px;font-size:13px;color:#6c6}
    .connected-url{color:#aaa;word-break:break-all;font-size:12px}
    .setup-steps{display:flex;flex-direction:column;gap:16px;margin-bottom:24px}
    .setup-step{display:flex;gap:14px;align-items:flex-start}
    .setup-step-n{width:24px;height:24px;background:var(--accent);color:#0c0e14;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;flex-shrink:0;margin-top:2px}
    .setup-step-title{color:#f0f0f0;font-weight:bold;font-size:14px}
    .setup-step-body{color:#888;margin-top:3px;font-size:13px;line-height:1.5}
    .url-row{display:flex;gap:10px}
    #url-input{flex:1;background:var(--bg);border:1px solid #333;color:var(--text);padding:11px 14px;border-radius:7px;font-size:13px;font-family:Georgia,serif;outline:none}

    /* COMBO */
    .combo-wrap{position:relative}
    .combo-selected{min-height:42px;background:var(--surface);border:1px solid var(--border2);border-radius:6px;padding:6px 36px 6px 10px;cursor:pointer;display:flex;flex-wrap:wrap;gap:5px;align-items:center;position:relative}
    .combo-selected:focus-within{border-color:var(--accent)}
    .combo-arrow{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#666;pointer-events:none;font-size:12px}
    .combo-tag{background:var(--accent-dim);border:1px solid #3a3010;color:var(--accent);font-size:12px;padding:2px 6px 2px 8px;border-radius:10px;display:flex;align-items:center;gap:4px;white-space:nowrap}
    .combo-tag-remove{background:none;border:none;color:#a08020;cursor:pointer;font-size:14px;line-height:1;padding:0}
    .combo-placeholder{color:#555;font-size:14px}
    .combo-dropdown{display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--surface2);border:1px solid var(--border2);border-radius:8px;z-index:200;max-height:260px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.5)}
    .combo-dropdown.open{display:block}
    .combo-search{width:100%;background:var(--bg);border:none;border-bottom:1px solid var(--border2);color:var(--text);padding:10px 12px;font-size:13px;font-family:Georgia,serif;outline:none}
    .combo-list{max-height:180px;overflow-y:auto}
    .combo-item{padding:9px 12px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .1s}
    .combo-item:hover{background:#1e2030}
    .combo-item.selected{color:var(--accent)}
    .combo-item .check{width:14px;height:14px;border:1px solid #444;border-radius:3px;display:inline-block;flex-shrink:0}
    .combo-item.selected .check{background:var(--accent);border-color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:10px;color:#0c0e14}
    .combo-add-row{padding:8px 12px;border-top:1px solid var(--border2)}
    .combo-add-btn{background:none;border:1px dashed #444;color:#888;padding:5px 12px;border-radius:5px;cursor:pointer;font-size:12px;font-family:Georgia,serif;width:100%;text-align:left}
    .combo-add-btn:hover{border-color:var(--accent);color:var(--accent)}
    .combo-empty{padding:12px;color:#555;font-size:13px;text-align:center}

    /* HERO */
    .hero{text-align:center;padding:36px 16px 28px;border-bottom:1px solid #1a1c24}
    .hero-title{font-size:clamp(20px,3.5vw,34px);color:var(--accent);margin-bottom:8px;letter-spacing:.3px}
    .hero-sub{color:var(--text-dim);margin-bottom:22px;font-size:15px}
    .search-box{display:flex;max-width:580px;margin:0 auto;border:1px solid #2a2a3a;border-radius:8px;overflow:hidden}
    #search-input{flex:1;background:var(--surface);color:var(--text);border:none;padding:13px 16px;font-size:14px;font-family:Georgia,serif;outline:none}
    .btn-search{background:var(--accent);color:#0c0e14;border:none;padding:13px 24px;font-weight:bold;cursor:pointer;font-family:Georgia,serif;font-size:14px}

    /* SORT / FILTER BAR */
    .filter-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:16px 0 4px}
    .filter-bar select{background:var(--surface);border:1px solid var(--border2);color:var(--text-mid);padding:7px 10px;border-radius:6px;font-family:Georgia,serif;font-size:13px;cursor:pointer;outline:none}
    .filter-bar select:focus{border-color:var(--accent)}
    .filter-chip{background:var(--surface2);border:1px solid var(--border2);color:var(--text-mid);padding:5px 10px;border-radius:16px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:4px;white-space:nowrap;font-family:Georgia,serif}
    .filter-chip.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
    .filter-clear{background:none;border:none;color:#555;font-size:12px;cursor:pointer;font-family:Georgia,serif;text-decoration:underline;white-space:nowrap}
    .filter-clear:hover{color:var(--accent)}
    .filter-sep{color:#333;font-size:14px;flex-shrink:0}

    /* TABS */
    .nav-tabs{display:flex;border-bottom:1px solid var(--border);margin-top:24px;gap:4px;overflow-x:auto}
    .section-title{font-size:16px;color:var(--text-mid);margin:20px 0 14px;font-weight:bold}

    /* GRID */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px}
    .grid.compact{grid-template-columns:1fr;gap:6px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;text-align:left;color:inherit;width:100%;font-family:Georgia,serif;transition:border-color .2s,background .2s}
    .card:hover{border-color:var(--accent)}
    .card-issue{font-size:14px;font-weight:bold;color:var(--text);line-height:1.4;margin-bottom:8px}
    .card-meta{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
    .card-meta-item{font-size:11px;color:var(--text-dim)}
    .card-preview{font-size:12px;color:var(--text-dim);border-left:2px solid var(--border2);padding-left:8px;margin:6px 0;line-height:1.5}
    .card-footer{display:flex;justify-content:space-between;margin-top:10px;flex-wrap:wrap;gap:4px;align-items:center}
    .card-tag{font-size:11px;color:var(--accent);background:var(--accent-dim);padding:2px 8px;border-radius:10px}
    .card-tools{font-size:11px;color:var(--text-dim)}
    .card-comment-badge{font-size:11px;color:#6ab0f5;background:#0d1520;border:1px solid #1a2a40;padding:2px 7px;border-radius:10px}
    body.light .card-comment-badge{background:#ddeeff;border-color:#aaccee;color:#1a6abf}
    /* collapsed compact view */
    .grid.compact .card{border-radius:7px;padding:10px 14px;display:flex;align-items:center;gap:12px}
    .grid.compact .card-issue{margin-bottom:0;font-size:13px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .grid.compact .card-meta{display:none}
    .grid.compact .card-preview{display:none}
    .grid.compact .card-footer{margin-top:0;flex-shrink:0}
    /* view toggle btn */
    .btn-view-toggle{background:none;border:1px solid var(--border2);color:var(--text-dim);padding:5px 9px;border-radius:6px;cursor:pointer;font-size:14px;line-height:1;transition:border-color .15s}
    .btn-view-toggle:hover{border-color:var(--accent);color:var(--accent)}

    /* EMPTY */
    .empty{text-align:center;padding:50px 20px;background:var(--surface);border-radius:10px;border:1px dashed var(--border2);color:#555}
    .empty-icon{font-size:36px;display:block;margin-bottom:10px}

    /* FORM */
    .form-wrap{max-width:680px;margin:0 auto}
    .form-title{font-size:22px;color:var(--accent);margin-bottom:22px}
    .form{display:flex;flex-direction:column;gap:18px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .field{display:flex;flex-direction:column;gap:7px}
    label.lbl{font-size:12px;color:var(--text-dim);font-weight:bold;letter-spacing:.5px;text-transform:uppercase}
    input.inp,textarea.inp{background:var(--surface);border:1px solid var(--border2);color:var(--text);padding:10px 13px;border-radius:6px;font-size:14px;font-family:Georgia,serif;outline:none;width:100%}
    textarea.inp{resize:vertical}
    .step-row{display:flex;align-items:center;gap:8px}
    .step-num{width:24px;height:24px;background:var(--accent);color:#0c0e14;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;flex-shrink:0}
    #steps-container,#steps-container-edit{display:flex;flex-direction:column;gap:8px}
    .form-actions{display:flex;justify-content:flex-end;gap:10px;padding-top:4px}

    /* DETAIL */
    .detail-wrap{max-width:700px;margin:0 auto}
    .detail-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px 26px;margin-bottom:20px}
    .detail-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
    .detail-title{font-size:20px;color:var(--text);line-height:1.4;flex:1;margin-right:14px}
    .detail-btns{display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap}
    .meta-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:22px}
    .badge{background:var(--surface2);border:1px solid var(--border2);padding:3px 11px;border-radius:16px;font-size:12px;color:var(--text-mid)}
    .badge-tool{background:var(--accent-dim);border:1px solid var(--border2);color:var(--accent)}
    .detail-sec{margin-bottom:20px}
    .detail-sec-title{font-size:12px;color:var(--accent);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px;font-weight:bold}
    .detail-text{color:var(--text-mid);font-size:14px;line-height:1.6}
    .step-list{padding-left:18px}
    .step-list li{color:var(--text-mid);font-size:14px;line-height:1.7;margin-bottom:4px}
    .timestamps{color:var(--text-dim);font-size:12px;border-top:1px solid var(--border);padding-top:12px;margin-top:16px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px}
    .synced-label{color:var(--green)}

    /* COMMENTS */
    .comments-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px 26px}
    .comments-title{font-size:14px;color:var(--accent);font-weight:bold;letter-spacing:.5px;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .comment-count{background:var(--surface2);color:var(--text-dim);font-size:11px;padding:2px 8px;border-radius:10px;font-weight:normal;letter-spacing:0;text-transform:none}
    .comments-list{display:flex;flex-direction:column;gap:14px;margin-bottom:20px}
    .comment-item{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px 14px}
    .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .comment-author{font-size:13px;font-weight:bold;color:var(--text)}
    .comment-time{font-size:11px;color:var(--text-dim)}
    .comment-body{font-size:14px;color:var(--text-mid);line-height:1.6;white-space:pre-wrap}
    .comment-delete{background:none;border:none;color:var(--border2);cursor:pointer;font-size:14px;transition:color .15s;padding:0 4px}
    .comment-delete:hover{color:var(--red)}
    .comment-form{display:flex;flex-direction:column;gap:10px}
    .comment-inputs{display:flex;gap:10px}
    .comment-author-inp{flex:0 0 160px;background:var(--bg);border:1px solid var(--border2);color:var(--text);padding:9px 12px;border-radius:6px;font-size:13px;font-family:Georgia,serif;outline:none}
    .comment-text-inp{flex:1;background:var(--bg);border:1px solid var(--border2);color:var(--text);padding:9px 12px;border-radius:6px;font-size:13px;font-family:Georgia,serif;outline:none;resize:vertical;min-height:70px}
    .comment-submit{background:var(--accent);color:#0c0e14;border:none;padding:9px 18px;border-radius:6px;font-weight:bold;cursor:pointer;font-family:Georgia,serif;font-size:13px;align-self:flex-end}
    .comments-empty{color:var(--text-dim);font-size:13px;text-align:center;padding:20px}

    /* DB */
    .db-section{margin-bottom:32px}
    .db-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .db-title{font-size:18px;color:var(--accent);font-weight:bold}
    .db-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
    .db-item{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
    .db-item-name{font-size:14px;color:var(--text)}
    .db-item-del{background:none;border:none;color:#555;cursor:pointer;font-size:16px;line-height:1;transition:color .15s}
    .db-item-del:hover{color:var(--red)}
    .db-add-row{display:flex;gap:10px;margin-top:12px}
    .db-add-input{flex:1;background:var(--surface);border:1px solid var(--border2);color:var(--text);padding:10px 13px;border-radius:6px;font-size:14px;font-family:Georgia,serif;outline:none}
    .db-add-btn{background:var(--accent);color:#0c0e14;border:none;padding:10px 18px;border-radius:6px;font-weight:bold;cursor:pointer;font-family:Georgia,serif;white-space:nowrap}

    /* TOAST */
    #toast{position:fixed;bottom:22px;right:22px;color:#fff;padding:11px 18px;border-radius:8px;z-index:999;font-family:Georgia,serif;font-size:13px;box-shadow:0 4px 20px rgba(0,0,0,.6);display:none;max-width:320px}

    /* LOADING */
    #loading-screen{display:none;position:fixed;inset:0;background:var(--bg);align-items:center;justify-content:center;flex-direction:column;gap:16px;z-index:200}
    .spinner{width:34px;height:34px;border:3px solid #222;border-top:3px solid var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* PRINT */
    @media print{
      header,#toast,#loading-screen,.modal-overlay,.comments-card,.detail-btns,.btn-back,.nav-tabs,.filter-bar{display:none!important}
      body{background:#fff;color:#000;font-family:Georgia,serif}
      main{max-width:100%;padding:0}
      .view{display:none!important}
      #print-area{display:block!important}
      .detail-card{background:#fff;border:1px solid #ccc;box-shadow:none;padding:20px}
      .detail-title{color:#000;font-size:18px}
      .detail-sec-title{color:#444}
      .badge{background:#eee;color:#333;border-color:#ccc}
      .badge-tool{background:#fff8e0;color:#555;border-color:#ccc}
      .step-list li,.detail-text{color:#222}
      .timestamps,.synced-label{color:#777}
      a{color:#000}
    }
    #print-area{display:none}

    @media(max-width:560px){
      .two-col{grid-template-columns:1fr}
      header{padding:12px 14px}
      .modal-card{padding:24px 18px}
      .comment-inputs{flex-direction:column}
      .comment-author-inp{flex:none;width:100%}
      .filter-bar{gap:6px}
    }
  </style>
</head>
<body>

<div id="loading-screen"><div class="spinner"></div><p style="color:#f0c040">Syncing with Google Sheets‚Ä¶</p></div>
<div id="toast"></div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal-card">
    <button class="modal-close" id="modal-close-btn">‚úï</button>
    <h2 class="modal-title">‚öôÔ∏è Google Sheets Connection</h2>
    <p class="modal-sub">Connect a Google Sheet so all entries sync across every device for free.</p>
    <div id="connected-row" class="connected-row" style="display:none">‚úì Connected &nbsp;¬∑&nbsp; <span class="connected-url" id="connected-url-text"></span></div>
    <div class="setup-steps">
      <div class="setup-step"><div class="setup-step-n">1</div><div><div class="setup-step-title">Create a new Google Sheet</div><div class="setup-step-body">Go to <a href="https://sheets.google.com" target="_blank">sheets.google.com</a> and create a blank spreadsheet.</div></div></div>
      <div class="setup-step"><div class="setup-step-n">2</div><div><div class="setup-step-title">Open Apps Script</div><div class="setup-step-body">Click <strong>Extensions ‚Üí Apps Script</strong>. Delete any existing code.</div></div></div>
      <div class="setup-step"><div class="setup-step-n">3</div><div><div class="setup-step-title">Paste the backend code</div><div class="setup-step-body">Copy <strong>apps-script.js</strong> into the editor and click üíæ Save.</div></div></div>
      <div class="setup-step"><div class="setup-step-n">4</div><div><div class="setup-step-title">Deploy as Web App</div><div class="setup-step-body">Click <strong>Deploy ‚Üí New deployment</strong>. Type: Web app. Execute as: Me. Access: Anyone. Deploy and copy the URL.</div></div></div>
      <div class="setup-step"><div class="setup-step-n">5</div><div><div class="setup-step-title">Paste your URL below</div></div></div>
    </div>
    <div class="url-row"><input id="url-input" type="url" placeholder="https://script.google.com/macros/s/‚Ä¶"/><button class="btn-connect" id="connect-btn">Connect</button></div>
  </div>
</div>

<!-- HEADER -->
<header>
  <button id="logo-btn">‚ö° LightFix DB</button>
  <div class="header-right">
    <span id="sync-badge">‚Üª Syncing‚Ä¶</span>
    <span id="no-sheet-badge" title="Connect Google Sheets">‚ö†Ô∏è Not connected</span>
    <button class="btn-refresh" id="refresh-btn" title="Refresh (R)">‚Üª</button>
    <button class="btn-ghost" id="theme-btn" title="Toggle light/dark mode (T)">üåô</button>
    <button class="btn-view-toggle" id="view-toggle-btn" title="Toggle compact view (V)">‚ò∞</button>
    <button class="btn-ghost" id="settings-btn" title="Settings">‚öôÔ∏è</button>
    <button class="btn-primary" id="add-btn">+ Log Issue</button>
  </div>
</header>

<!-- PRINT AREA (hidden unless printing) -->
<div id="print-area"></div>

<main>
  <!-- HOME -->
  <div class="view active" id="view-home">
    <div class="hero">
      <h1 class="hero-title">Lighting Troubleshooting Database</h1>
      <p class="hero-sub">Your team's collective knowledge, synced to Google Sheets.</p>
      <div class="search-box">
        <input id="search-input" type="text" placeholder="Describe a lighting problem‚Ä¶"/>
        <button class="btn-search" id="search-btn">Search</button>
      </div>
    </div>
    <div class="nav-tabs">
      <button class="btn-tab active" data-tab="issues">Issues</button>
      <button class="btn-tab" data-tab="tools">üîß Tools</button>
      <button class="btn-tab" data-tab="equipment">‚öôÔ∏è Equipment</button>
      <button class="btn-tab" data-tab="locations">üìç Locations</button>
      <button class="btn-tab" data-tab="manufacturers">üè≠ Manufacturers</button>
    </div>

    <!-- ISSUES TAB -->
    <div id="tab-issues">
      <!-- Sort / Filter bar -->
      <div class="filter-bar">
        <select id="sort-select">
          <option value="newest">Sort: Newest first</option>
          <option value="oldest">Sort: Oldest first</option>
          <option value="az">Sort: A ‚Üí Z</option>
          <option value="za">Sort: Z ‚Üí A</option>
          <option value="steps">Sort: Most steps</option>
        </select>
        <span class="filter-sep">|</span>
        <select id="filter-mfr">
          <option value="">All manufacturers</option>
        </select>
        <select id="filter-loc">
          <option value="">All locations</option>
        </select>
        <select id="filter-equip">
          <option value="">All equipment</option>
        </select>
        <button class="filter-clear" id="filter-clear-btn" style="display:none">‚úï Clear filters</button>
      </div>
      <h2 class="section-title" id="list-title">All Issues</h2>
      <div id="entries-grid"></div>
    </div>

    <!-- TOOLS TAB -->
    <div id="tab-tools" style="display:none">
      <div class="db-section" style="margin-top:20px">
        <div class="db-header"><span class="db-title">üîß Tool Database</span><span style="color:#666;font-size:13px" id="tool-count"></span></div>
        <div class="db-grid" id="tools-db-grid"></div>
        <div class="db-add-row"><input class="db-add-input" id="new-tool-input" placeholder="Add new tool‚Ä¶ e.g. Cable tester"/><button class="db-add-btn" id="new-tool-btn">+ Add Tool</button></div>
      </div>
    </div>

    <!-- EQUIPMENT TAB -->
    <div id="tab-equipment" style="display:none">
      <div class="db-section" style="margin-top:20px">
        <div class="db-header"><span class="db-title">‚öôÔ∏è Equipment / Fixture Database</span><span style="color:#666;font-size:13px" id="equip-count"></span></div>
        <div class="db-grid" id="equip-db-grid"></div>
        <div class="db-add-row"><input class="db-add-input" id="new-equip-input" placeholder="Add fixture‚Ä¶ e.g. Source Four 750w, Moving Head 200w"/><button class="db-add-btn" id="new-equip-btn">+ Add Equipment</button></div>
      </div>
    </div>

    <!-- LOCATIONS TAB -->
    <div id="tab-locations" style="display:none">
      <div class="db-section" style="margin-top:20px">
        <div class="db-header"><span class="db-title">üìç Location Database</span><span style="color:#666;font-size:13px" id="loc-count"></span></div>
        <div class="db-grid" id="locs-db-grid"></div>
        <div class="db-add-row"><input class="db-add-input" id="new-loc-input" placeholder="Add location‚Ä¶ e.g. Stage Left, Grid, Booth"/><button class="db-add-btn" id="new-loc-btn">+ Add Location</button></div>
      </div>
    </div>

    <!-- MANUFACTURERS TAB -->
    <div id="tab-manufacturers" style="display:none">
      <div class="db-section" style="margin-top:20px">
        <div class="db-header"><span class="db-title">üè≠ Manufacturer Database</span><span style="color:#666;font-size:13px" id="mfr-count"></span></div>
        <div class="db-grid" id="mfrs-db-grid"></div>
        <div class="db-add-row"><input class="db-add-input" id="new-mfr-input" placeholder="Add manufacturer‚Ä¶ e.g. ETC"/><button class="db-add-btn" id="new-mfr-btn">+ Add Manufacturer</button></div>
      </div>
    </div>
  </div>

  <!-- ADD -->
  <div class="view" id="view-add">
    <div class="form-wrap">
      <button class="btn-back" id="add-back-btn">‚Üê Back</button>
      <h2 class="form-title">Log New Issue</h2>
      <div class="form">
        <div class="field"><label class="lbl">Issue / Problem *</label><textarea class="inp" id="add-issue" rows="3" placeholder="Describe the lighting issue‚Ä¶"></textarea></div>
        <div class="two-col">
          <div class="field">
            <label class="lbl">Location</label>
            <div class="combo-wrap combo-single" id="add-loc-wrap">
              <div class="combo-selected" id="add-loc-selected" tabindex="0"><span class="combo-placeholder" id="add-loc-placeholder">Select or type location‚Ä¶</span><span class="combo-arrow">‚ñæ</span></div>
              <div class="combo-dropdown" id="add-loc-dropdown"><input class="combo-search" id="add-loc-search" placeholder="Search locations‚Ä¶"/><div class="combo-list" id="add-loc-list"></div><div class="combo-add-row"><button class="combo-add-btn" id="add-loc-add-btn">+ Add new location</button></div></div>
            </div>
            <input type="hidden" id="add-loc-value"/>
          </div>
          <div class="field"><label class="lbl">Date</label><input class="inp" id="add-date" type="date"/></div>
        </div>
        <div class="field"><label class="lbl">Reported By</label><input class="inp" id="add-reported-by" type="text" placeholder="Name or initials"/></div>
        <div class="two-col">
          <div class="field">
            <label class="lbl">Manufacturer</label>
            <div class="combo-wrap combo-single" id="add-mfr-wrap">
              <div class="combo-selected" id="add-mfr-selected" tabindex="0"><span class="combo-placeholder" id="add-mfr-placeholder">Select or type manufacturer‚Ä¶</span><span class="combo-arrow">‚ñæ</span></div>
              <div class="combo-dropdown" id="add-mfr-dropdown"><input class="combo-search" id="add-mfr-search" placeholder="Search manufacturers‚Ä¶"/><div class="combo-list" id="add-mfr-list"></div><div class="combo-add-row"><button class="combo-add-btn" id="add-mfr-add-btn">+ Add new manufacturer</button></div></div>
            </div>
            <input type="hidden" id="add-mfr-value"/>
          </div>
          <div class="field">
            <label class="lbl">Equipment / Fixture</label>
            <div class="combo-wrap combo-single" id="add-equip-wrap">
              <div class="combo-selected" id="add-equip-selected" tabindex="0"><span class="combo-placeholder" id="add-equip-placeholder">Select or type fixture‚Ä¶</span><span class="combo-arrow">‚ñæ</span></div>
              <div class="combo-dropdown" id="add-equip-dropdown"><input class="combo-search" id="add-equip-search" placeholder="Search fixtures‚Ä¶"/><div class="combo-list" id="add-equip-list"></div><div class="combo-add-row"><button class="combo-add-btn" id="add-equip-add-btn">+ Add new fixture</button></div></div>
            </div>
            <input type="hidden" id="add-equip-value"/>
          </div>
        </div>
        <div class="field">
          <label class="lbl">Tools Used</label>
          <div class="combo-wrap" id="add-tools-wrap">
            <div class="combo-selected" id="add-tools-selected" tabindex="0"><span class="combo-placeholder" id="add-tools-placeholder">Select or search tools‚Ä¶</span><span class="combo-arrow">‚ñæ</span></div>
            <div class="combo-dropdown" id="add-tools-dropdown"><input class="combo-search" id="add-tools-search" placeholder="Search tools‚Ä¶"/><div class="combo-list" id="add-tools-list"></div><div class="combo-add-row"><button class="combo-add-btn" id="add-tools-add-btn">+ Add new tool</button></div></div>
          </div>
        </div>
        <div class="field"><label class="lbl">Steps Taken to Solve</label><div id="steps-container"></div><button type="button" class="btn-add-step" id="add-step-btn">+ Add Step</button></div>
        <div class="field"><label class="lbl">Helpful Links / Documents</label><textarea class="inp" id="add-links" rows="2" placeholder="Paste URLs here, one per line‚Ä¶"></textarea></div>
        <div class="form-actions"><button class="btn-secondary" id="add-cancel-btn">Cancel</button><button class="btn-primary" id="add-save-btn">Save to Google Sheets</button></div>
      </div>
    </div>
  </div>

  <!-- EDIT -->
  <div class="view" id="view-edit">
    <div class="form-wrap">
      <button class="btn-back" id="edit-back-btn">‚Üê Back to Entry</button>
      <h2 class="form-title">Edit Entry</h2>
      <input type="hidden" id="edit-id"/>
      <div class="form">
        <div class="field"><label class="lbl">Issue / Problem *</label><textarea class="inp" id="edit-issue" rows="3"></textarea></div>
        <div class="two-col">
          <div class="field">
            <label class="lbl">Location</label>
            <div class="combo-wrap combo-single" id="edit-loc-wrap">
              <div class="combo-selected" id="edit-loc-selected" tabindex="0"><span class="combo-placeholder" id="edit-loc-placeholder">Select or type location‚Ä¶</span><span class="combo-arrow">‚ñæ</span></div>
              <div class="combo-dropdown" id="edit-loc-dropdown"><input class="combo-search" id="edit-loc-search" placeholder="Search locations‚Ä¶"/><div class="combo-list" id="edit-loc-list"></div><div class="combo-add-row"><button class="combo-add-btn" id="edit-loc-add-btn">+ Add new location</button></div></div>
            </div>
            <input type="hidden" id="edit-loc-value"/>
          </div>
          <div class="field"><label class="lbl">Date</label><input class="inp" id="edit-date" type="date"/></div>
        </div>
        <div class="field"><label class="lbl">Reported By</label><input class="inp" id="edit-reported-by" type="text"/></div>
        <div class="two-col">
          <div class="field">
            <label class="lbl">Manufacturer</label>
            <div class="combo-wrap combo-single" id="edit-mfr-wrap">
              <div class="combo-selected" id="edit-mfr-selected" tabindex="0"><span class="combo-placeholder" id="edit-mfr-placeholder">Select or type manufacturer‚Ä¶</span><span class="combo-arrow">‚ñæ</span></div>
              <div class="combo-dropdown" id="edit-mfr-dropdown"><input class="combo-search" id="edit-mfr-search" placeholder="Search manufacturers‚Ä¶"/><div class="combo-list" id="edit-mfr-list"></div><div class="combo-add-row"><button class="combo-add-btn" id="edit-mfr-add-btn">+ Add new manufacturer</button></div></div>
            </div>
            <input type="hidden" id="edit-mfr-value"/>
          </div>
          <div class="field">
            <label class="lbl">Equipment / Fixture</label>
            <div class="combo-wrap combo-single" id="edit-equip-wrap">
              <div class="combo-selected" id="edit-equip-selected" tabindex="0"><span class="combo-placeholder" id="edit-equip-placeholder">Select or type fixture‚Ä¶</span><span class="combo-arrow">‚ñæ</span></div>
              <div class="combo-dropdown" id="edit-equip-dropdown"><input class="combo-search" id="edit-equip-search" placeholder="Search fixtures‚Ä¶"/><div class="combo-list" id="edit-equip-list"></div><div class="combo-add-row"><button class="combo-add-btn" id="edit-equip-add-btn">+ Add new fixture</button></div></div>
            </div>
            <input type="hidden" id="edit-equip-value"/>
          </div>
        </div>
        <div class="field">
          <label class="lbl">Tools Used</label>
          <div class="combo-wrap" id="edit-tools-wrap">
            <div class="combo-selected" id="edit-tools-selected" tabindex="0"><span class="combo-placeholder" id="edit-tools-placeholder">Select or search tools‚Ä¶</span><span class="combo-arrow">‚ñæ</span></div>
            <div class="combo-dropdown" id="edit-tools-dropdown"><input class="combo-search" id="edit-tools-search" placeholder="Search tools‚Ä¶"/><div class="combo-list" id="edit-tools-list"></div><div class="combo-add-row"><button class="combo-add-btn" id="edit-tools-add-btn">+ Add new tool</button></div></div>
          </div>
        </div>
        <div class="field"><label class="lbl">Steps Taken to Solve</label><div id="steps-container-edit"></div><button type="button" class="btn-add-step" id="edit-add-step-btn">+ Add Step</button></div>
        <div class="field"><label class="lbl">Helpful Links / Documents</label><textarea class="inp" id="edit-links" rows="2"></textarea></div>
        <div class="form-actions"><button class="btn-secondary" id="edit-cancel-btn">Cancel</button><button class="btn-primary" id="edit-save-btn">Update Entry</button></div>
      </div>
    </div>
  </div>

  <!-- DETAIL -->
  <div class="view" id="view-detail">
    <div class="detail-wrap">
      <button class="btn-back" id="detail-back-btn">‚Üê All Issues</button>
      <div class="detail-card">
        <div class="detail-header">
          <h2 class="detail-title" id="detail-title"></h2>
          <div class="detail-btns">
            <button class="btn-print" id="detail-print-btn" title="Print / Save PDF">üñ®Ô∏è</button>
            <button class="btn-edit" id="detail-edit-btn">‚úèÔ∏è Edit</button>
            <button class="btn-delete" id="detail-delete-btn">üóëÔ∏è</button>
          </div>
        </div>
        <div class="meta-row" id="detail-meta"></div>
        <div id="detail-steps-sec" class="detail-sec"><div class="detail-sec-title">Steps Taken</div><ol class="step-list" id="detail-steps"></ol></div>
        <div id="detail-tools-sec" class="detail-sec"><div class="detail-sec-title">Tools Used</div><div id="detail-tools-badges" style="display:flex;flex-wrap:wrap;gap:6px"></div></div>
        <div id="detail-links-sec" class="detail-sec"><div class="detail-sec-title">Helpful Links</div><div id="detail-links"></div></div>
        <div class="timestamps"><span id="detail-created"></span><span class="synced-label">‚úì Synced to Google Sheets</span></div>
      </div>
      <div class="comments-card">
        <div class="comments-title">üí¨ Comments & Notes <span class="comment-count" id="comment-count">0</span></div>
        <div class="comments-list" id="comments-list"></div>
        <div class="comment-form">
          <div class="comment-inputs">
            <input class="comment-author-inp" id="comment-author" placeholder="Your name‚Ä¶"/>
            <textarea class="comment-text-inp" id="comment-text" placeholder="Add a note, update, or observation‚Ä¶" rows="2"></textarea>
          </div>
          <button class="comment-submit" id="comment-submit-btn">Post Comment</button>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- KEYBOARD SHORTCUT HINT -->
<div class="kbd-hint" id="kbd-hint">
  <span><kbd>N</kbd> New issue</span>
  <span><kbd>R</kbd> Refresh</span>
  <span><kbd>T</kbd> Theme</span>
  <span><kbd>V</kbd> View</span>
  <span><kbd>/</kbd> Search</span>
  <span><kbd>Esc</kbd> Back</span>
  <span><kbd>?</kbd> Hide</span>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SCRIPT_URL_KEY='lightfix-script-url';
const TOOLS_KEY='lightfix-tools-db';
const MFRS_KEY='lightfix-mfrs-db';
const EQUIP_KEY='lightfix-equip-db';
const LOCS_KEY='lightfix-locs-db';
const COMMENTS_KEY='lightfix-comments';

let scriptUrl=localStorage.getItem(SCRIPT_URL_KEY)||'';
let allEntries=[];
let toolsDB=JSON.parse(localStorage.getItem(TOOLS_KEY)||'null')||defaultTools();
let mfrsDB=JSON.parse(localStorage.getItem(MFRS_KEY)||'null')||defaultMfrs();
let equipDB=JSON.parse(localStorage.getItem(EQUIP_KEY)||'null')||defaultEquip();
let locsDB=JSON.parse(localStorage.getItem(LOCS_KEY)||'null')||defaultLocs();
let commentsDB={};
let currentDetailId=null;
let addToolsSel=[],editToolsSel=[];
let addMfrSel='',editMfrSel='';
let addEquipSel='',editEquipSel='';
let addLocSel='',editLocSel='';

// active filters
let activeSort='newest',activeMfr='',activeLoc='',activeEquip='';

function defaultTools(){return['Multimeter','DMX Analyzer','Dimmer Tester','Cable Tester','Oscilloscope','Gel Roller','C-Wrench','Pipe Wrench','Screwdriver Set','Voltage Tester','Patch Bay','Signal Generator','Light Meter','Infrared Thermometer']}
function defaultMfrs(){return['ETC','Chauvet','Martin','Robe','Arri','Aputure','Litepanels','Rosco','Strand Lighting','Leviton','Elation','High End Systems','City Theatrical','TMB']}
function defaultEquip(){return['Source Four 750w','Source Four 575w','Moving Head 200w','LED Par 64','Fresnel 1kw','Cyc Light','Strip Light','Follow Spot','Dimmer Rack','DMX Controller']}
function defaultLocs(){return['Stage Left','Stage Right','Center Stage','Upstage','Downstage','Lighting Booth','Grid','Catwalk','FOH','Backstage']}
function saveToolsDB(){localStorage.setItem(TOOLS_KEY,JSON.stringify(toolsDB))}
function saveMfrsDB(){localStorage.setItem(MFRS_KEY,JSON.stringify(mfrsDB))}
function saveEquipDB(){localStorage.setItem(EQUIP_KEY,JSON.stringify(equipDB))}
function saveLocsDB(){localStorage.setItem(LOCS_KEY,JSON.stringify(locsDB))}
function loadComments(){try{commentsDB=JSON.parse(localStorage.getItem(COMMENTS_KEY)||'{}')}catch{commentsDB={}}}
function saveComments(){localStorage.setItem(COMMENTS_KEY,JSON.stringify(commentsDB))}
function getComments(id){return commentsDB[id]||[]}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function $(id){return document.getElementById(id)}
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function showView(n){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));$('view-'+n).classList.add('active');window.scrollTo(0,0);document.querySelectorAll('.combo-dropdown.open').forEach(d=>d.classList.remove('open'))}
function showToast(msg,type='success'){const t=$('toast');t.textContent=(type==='error'?'‚ö†Ô∏è ':'‚úì ')+msg;t.style.background=type==='error'?'#8b2020':'#1a5c2a';t.style.display='block';clearTimeout(t._timer);t._timer=setTimeout(()=>t.style.display='none',3500)}
function setLoading(on){$('loading-screen').style.display=on?'flex':'none'}
function setSyncing(on){$('sync-badge').style.display=on?'inline-block':'none'}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SORT & FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyFiltersAndSort(entries){
  let res=entries.slice();
  if(activeMfr) res=res.filter(e=>(e.manufacturer||'')===activeMfr);
  if(activeLoc)  res=res.filter(e=>(e.location||'')===activeLoc);
  if(activeEquip) res=res.filter(e=>(e.equipment||'')===activeEquip);
  switch(activeSort){
    case'oldest': res.sort((a,b)=>new Date(a.createdAt||0)-new Date(b.createdAt||0)); break;
    case'az':     res.sort((a,b)=>(a.issue||'').localeCompare(b.issue||'')); break;
    case'za':     res.sort((a,b)=>(b.issue||'').localeCompare(a.issue||'')); break;
    case'steps':  res.sort((a,b)=>(b.steps||[]).length-(a.steps||[]).length); break;
    default:      res.sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0));
  }
  return res;
}

function populateFilterSelects(){
  // manufacturer
  const mfrSel=$('filter-mfr');
  const prevMfr=mfrSel.value;
  mfrSel.innerHTML='<option value="">All manufacturers</option>';
  [...new Set(allEntries.map(e=>e.manufacturer).filter(Boolean))].sort().forEach(m=>{
    const o=document.createElement('option');o.value=m;o.textContent=m;mfrSel.appendChild(o);
  });
  mfrSel.value=prevMfr;

  // location
  const locSel=$('filter-loc');
  const prevLoc=locSel.value;
  locSel.innerHTML='<option value="">All locations</option>';
  [...new Set(allEntries.map(e=>e.location).filter(Boolean))].sort().forEach(l=>{
    const o=document.createElement('option');o.value=l;o.textContent=l;locSel.appendChild(o);
  });
  locSel.value=prevLoc;

  // equipment
  const equipSel=$('filter-equip');
  const prevEquip=equipSel.value;
  equipSel.innerHTML='<option value="">All equipment</option>';
  [...new Set(allEntries.map(e=>e.equipment).filter(Boolean))].sort().forEach(eq=>{
    const o=document.createElement('option');o.value=eq;o.textContent=eq;equipSel.appendChild(o);
  });
  equipSel.value=prevEquip;
}

function updateFilterClearBtn(){
  const active=activeMfr||activeLoc||activeEquip;
  $('filter-clear-btn').style.display=active?'inline':'none';
}

$('sort-select').addEventListener('change',()=>{activeSort=$('sort-select').value;refreshIssues()});
$('filter-mfr').addEventListener('change',()=>{activeMfr=$('filter-mfr').value;updateFilterClearBtn();refreshIssues()});
$('filter-loc').addEventListener('change',()=>{activeLoc=$('filter-loc').value;updateFilterClearBtn();refreshIssues()});
$('filter-equip').addEventListener('change',()=>{activeEquip=$('filter-equip').value;updateFilterClearBtn();refreshIssues()});
$('filter-clear-btn').addEventListener('click',()=>{
  activeMfr='';activeLoc='';activeEquip='';
  $('filter-mfr').value='';$('filter-loc').value='';$('filter-equip').value='';
  updateFilterClearBtn();refreshIssues();
});

function refreshIssues(baseEntries){
  const base=baseEntries||allEntries;
  const filtered=applyFiltersAndSort(base);
  renderGrid(filtered);
  const hasSearch=$('search-input').value.trim();
  if(!hasSearch) $('list-title').textContent='All Issues ('+filtered.length+(filtered.length!==allEntries.length?' of '+allEntries.length:'')+')';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMBO ‚Äî MULTI-SELECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildMultiCombo(ids,getItems,getSelected,setSelected,onAddNew,addLabel='tool'){
  const selEl=$(ids.selected),phEl=$(ids.placeholder),dd=$(ids.dropdown),srch=$(ids.search),listEl=$(ids.list),addBtn=$(ids.addBtn);
  function renderTags(){
    selEl.querySelectorAll('.combo-tag').forEach(t=>t.remove());
    const sel=getSelected();phEl.style.display=sel.length?'none':'inline';
    sel.forEach(item=>{const tag=document.createElement('span');tag.className='combo-tag';tag.innerHTML=esc(item)+`<button class="combo-tag-remove" data-val="${esc(item)}">√ó</button>`;tag.querySelector('.combo-tag-remove').addEventListener('click',e=>{e.stopPropagation();setSelected(getSelected().filter(x=>x!==e.target.dataset.val));renderTags();renderList()});selEl.insertBefore(tag,phEl)});
  }
  function renderList(f=''){
    const items=getItems(),sel=getSelected(),fl=f.toLowerCase();
    const filtered=fl?items.filter(i=>i.toLowerCase().includes(fl)):items;
    listEl.innerHTML=filtered.length?filtered.map(item=>`<div class="combo-item ${sel.includes(item)?'selected':''}" data-val="${esc(item)}"><span class="check">${sel.includes(item)?'‚úì':''}</span>${esc(item)}</div>`).join(''):'<div class="combo-empty">No matches.</div>';
    listEl.querySelectorAll('.combo-item').forEach(el=>el.addEventListener('click',()=>{const v=el.dataset.val,cur=getSelected();setSelected(cur.includes(v)?cur.filter(x=>x!==v):[...cur,v]);renderTags();renderList(srch.value)}));
    addBtn.textContent=srch.value.trim()?`+ Add "${srch.value.trim()}" as new ${addLabel}`:`+ Add new ${addLabel}`;
  }
  selEl.addEventListener('click',()=>{const open=dd.classList.contains('open');document.querySelectorAll('.combo-dropdown.open').forEach(d=>d.classList.remove('open'));if(!open){dd.classList.add('open');srch.value='';renderList();srch.focus()}});
  srch.addEventListener('input',()=>renderList(srch.value));srch.addEventListener('keydown',e=>e.stopPropagation());
  addBtn.addEventListener('click',()=>{const val=srch.value.trim()||prompt(`Enter new ${addLabel} name:`);if(!val)return;onAddNew(val);renderList(srch.value)});
  renderTags();return{renderTags,renderList};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMBO ‚Äî SINGLE-SELECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSingleCombo(ids,getItems,getValue,setValue,onAddNew,addLabel='item'){
  const selEl=$(ids.selected),phEl=$(ids.placeholder),dd=$(ids.dropdown),srch=$(ids.search),listEl=$(ids.list),addBtn=$(ids.addBtn);
  function renderLabel(){
    selEl.querySelectorAll('.combo-tag').forEach(t=>t.remove());const v=getValue();phEl.style.display=v?'none':'inline';
    if(v){const tag=document.createElement('span');tag.className='combo-tag';tag.innerHTML=esc(v)+`<button class="combo-tag-remove">√ó</button>`;tag.querySelector('.combo-tag-remove').addEventListener('click',e=>{e.stopPropagation();setValue('');renderLabel();renderList()});selEl.insertBefore(tag,phEl)}
  }
  function renderList(f=''){
    const items=getItems(),fl=f.toLowerCase();
    const filtered=fl?items.filter(i=>i.toLowerCase().includes(fl)):items;
    listEl.innerHTML=filtered.length?filtered.map(item=>`<div class="combo-item ${getValue()===item?'selected':''}" data-val="${esc(item)}"><span class="check">${getValue()===item?'‚úì':''}</span>${esc(item)}</div>`).join(''):'<div class="combo-empty">No matches.</div>';
    listEl.querySelectorAll('.combo-item').forEach(el=>el.addEventListener('click',()=>{setValue(el.dataset.val);renderLabel();dd.classList.remove('open')}));
    addBtn.textContent=srch.value.trim()?`+ Add "${srch.value.trim()}" as ${addLabel}`:`+ Add new ${addLabel}`;
  }
  selEl.addEventListener('click',()=>{const open=dd.classList.contains('open');document.querySelectorAll('.combo-dropdown.open').forEach(d=>d.classList.remove('open'));if(!open){dd.classList.add('open');srch.value='';renderList();srch.focus()}});
  srch.addEventListener('input',()=>renderList(srch.value));srch.addEventListener('keydown',e=>e.stopPropagation());
  addBtn.addEventListener('click',()=>{const val=srch.value.trim()||prompt(`Enter new ${addLabel}:`);if(!val)return;onAddNew(val);renderList(srch.value)});
  renderLabel();return{renderLabel,renderList};
}

document.addEventListener('click',e=>{if(!e.target.closest('.combo-wrap'))document.querySelectorAll('.combo-dropdown.open').forEach(d=>d.classList.remove('open'))});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT COMBOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let addToolsCombo,editToolsCombo,addMfrCombo,editMfrCombo,addEquipCombo,editEquipCombo,addLocCombo,editLocCombo;

function mkAddDb(db,save,render,label){
  return val=>{if(!db.includes(val)){db.push(val);save();render()}showToast(`"${val}" added to ${label} Database`)};
}

function initCombos(){
  // TOOLS
  addToolsCombo=buildMultiCombo({selected:'add-tools-selected',placeholder:'add-tools-placeholder',dropdown:'add-tools-dropdown',search:'add-tools-search',list:'add-tools-list',addBtn:'add-tools-add-btn'},()=>toolsDB.slice().sort(),()=>addToolsSel,v=>{addToolsSel=v},val=>{if(!toolsDB.includes(val)){toolsDB.push(val);saveToolsDB();renderDBs()}if(!addToolsSel.includes(val))addToolsSel.push(val);addToolsCombo.renderTags();showToast(`"${val}" added to Tool Database`)},'tool');
  editToolsCombo=buildMultiCombo({selected:'edit-tools-selected',placeholder:'edit-tools-placeholder',dropdown:'edit-tools-dropdown',search:'edit-tools-search',list:'edit-tools-list',addBtn:'edit-tools-add-btn'},()=>toolsDB.slice().sort(),()=>editToolsSel,v=>{editToolsSel=v},val=>{if(!toolsDB.includes(val)){toolsDB.push(val);saveToolsDB();renderDBs()}if(!editToolsSel.includes(val))editToolsSel.push(val);editToolsCombo.renderTags();showToast(`"${val}" added to Tool Database`)},'tool');

  // MANUFACTURER
  addMfrCombo=buildSingleCombo({selected:'add-mfr-selected',placeholder:'add-mfr-placeholder',dropdown:'add-mfr-dropdown',search:'add-mfr-search',list:'add-mfr-list',addBtn:'add-mfr-add-btn'},()=>mfrsDB.slice().sort(),()=>addMfrSel,v=>{addMfrSel=v;$('add-mfr-value').value=v},val=>{if(!mfrsDB.includes(val)){mfrsDB.push(val);saveMfrsDB();renderDBs()}addMfrSel=val;$('add-mfr-value').value=val;addMfrCombo.renderLabel();showToast(`"${val}" added to Manufacturer Database`)},'manufacturer');
  editMfrCombo=buildSingleCombo({selected:'edit-mfr-selected',placeholder:'edit-mfr-placeholder',dropdown:'edit-mfr-dropdown',search:'edit-mfr-search',list:'edit-mfr-list',addBtn:'edit-mfr-add-btn'},()=>mfrsDB.slice().sort(),()=>editMfrSel,v=>{editMfrSel=v;$('edit-mfr-value').value=v},val=>{if(!mfrsDB.includes(val)){mfrsDB.push(val);saveMfrsDB();renderDBs()}editMfrSel=val;$('edit-mfr-value').value=val;editMfrCombo.renderLabel();showToast(`"${val}" added to Manufacturer Database`)},'manufacturer');

  // EQUIPMENT
  addEquipCombo=buildSingleCombo({selected:'add-equip-selected',placeholder:'add-equip-placeholder',dropdown:'add-equip-dropdown',search:'add-equip-search',list:'add-equip-list',addBtn:'add-equip-add-btn'},()=>equipDB.slice().sort(),()=>addEquipSel,v=>{addEquipSel=v;$('add-equip-value').value=v},val=>{if(!equipDB.includes(val)){equipDB.push(val);saveEquipDB();renderDBs()}addEquipSel=val;$('add-equip-value').value=val;addEquipCombo.renderLabel();showToast(`"${val}" added to Equipment Database`)},'fixture');
  editEquipCombo=buildSingleCombo({selected:'edit-equip-selected',placeholder:'edit-equip-placeholder',dropdown:'edit-equip-dropdown',search:'edit-equip-search',list:'edit-equip-list',addBtn:'edit-equip-add-btn'},()=>equipDB.slice().sort(),()=>editEquipSel,v=>{editEquipSel=v;$('edit-equip-value').value=v},val=>{if(!equipDB.includes(val)){equipDB.push(val);saveEquipDB();renderDBs()}editEquipSel=val;$('edit-equip-value').value=val;editEquipCombo.renderLabel();showToast(`"${val}" added to Equipment Database`)},'fixture');

  // LOCATION
  addLocCombo=buildSingleCombo({selected:'add-loc-selected',placeholder:'add-loc-placeholder',dropdown:'add-loc-dropdown',search:'add-loc-search',list:'add-loc-list',addBtn:'add-loc-add-btn'},()=>locsDB.slice().sort(),()=>addLocSel,v=>{addLocSel=v;$('add-loc-value').value=v},val=>{if(!locsDB.includes(val)){locsDB.push(val);saveLocsDB();renderDBs()}addLocSel=val;$('add-loc-value').value=val;addLocCombo.renderLabel();showToast(`"${val}" added to Location Database`)},'location');
  editLocCombo=buildSingleCombo({selected:'edit-loc-selected',placeholder:'edit-loc-placeholder',dropdown:'edit-loc-dropdown',search:'edit-loc-search',list:'edit-loc-list',addBtn:'edit-loc-add-btn'},()=>locsDB.slice().sort(),()=>editLocSel,v=>{editLocSel=v;$('edit-loc-value').value=v},val=>{if(!locsDB.includes(val)){locsDB.push(val);saveLocsDB();renderDBs()}editLocSel=val;$('edit-loc-value').value=val;editLocCombo.renderLabel();showToast(`"${val}" added to Location Database`)},'location');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DB TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makeDbGrid(containerId,items,emoji,onDelete){
  const g=$(containerId);
  g.innerHTML=items.length?items.slice().sort().map(t=>`<div class="db-item"><span class="db-item-name">${emoji} ${esc(t)}</span><button class="db-item-del" data-val="${esc(t)}" title="Remove">√ó</button></div>`).join(''):`<div style="color:#555;font-size:13px">None yet.</div>`;
  g.querySelectorAll('.db-item-del').forEach(btn=>btn.addEventListener('click',()=>{if(!confirm(`Remove "${btn.dataset.val}"?`))return;onDelete(btn.dataset.val);renderDBs();showToast('Removed.')}));
}

function renderDBs(){
  $('tool-count').textContent=toolsDB.length+' tools';
  makeDbGrid('tools-db-grid',toolsDB,'üîß',val=>{toolsDB=toolsDB.filter(x=>x!==val);saveToolsDB()});
  $('mfr-count').textContent=mfrsDB.length+' manufacturers';
  makeDbGrid('mfrs-db-grid',mfrsDB,'üè≠',val=>{mfrsDB=mfrsDB.filter(x=>x!==val);saveMfrsDB()});
  $('equip-count').textContent=equipDB.length+' fixtures';
  makeDbGrid('equip-db-grid',equipDB,'‚öôÔ∏è',val=>{equipDB=equipDB.filter(x=>x!==val);saveEquipDB()});
  $('loc-count').textContent=locsDB.length+' locations';
  makeDbGrid('locs-db-grid',locsDB,'üìç',val=>{locsDB=locsDB.filter(x=>x!==val);saveLocsDB()});
}

// tab switching
document.querySelectorAll('.btn-tab').forEach(btn=>btn.addEventListener('click',()=>{
  document.querySelectorAll('.btn-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  ['issues','tools','equipment','locations','manufacturers'].forEach(t=>$('tab-'+t).style.display='none');
  $('tab-'+btn.dataset.tab).style.display='block';
}));

function dbAddHandler(inputId,btnId,db,save,render,label){
  $(btnId).addEventListener('click',()=>{const val=$(inputId).value.trim();if(!val)return;if(db.includes(val)){showToast(`"${val}" already exists.`,'error');return}db.push(val);save();render();$(inputId).value='';showToast(`"${val}" added!`)});
  $(inputId).addEventListener('keydown',e=>{if(e.key==='Enter')$(btnId).click()});
}
// will be called after init
function wireDbButtons(){
  dbAddHandler('new-tool-input','new-tool-btn',toolsDB,saveToolsDB,renderDBs,'Tool');
  dbAddHandler('new-mfr-input','new-mfr-btn',mfrsDB,saveMfrsDB,renderDBs,'Manufacturer');
  dbAddHandler('new-equip-input','new-equip-btn',equipDB,saveEquipDB,renderDBs,'Equipment');
  dbAddHandler('new-loc-input','new-loc-btn',locsDB,saveLocsDB,renderDBs,'Location');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateConnectionUI(){
  if(scriptUrl){$('no-sheet-badge').style.display='none';$('connected-row').style.display='flex';$('connected-url-text').textContent=scriptUrl.length>55?scriptUrl.slice(0,52)+'‚Ä¶':scriptUrl}
  else{$('no-sheet-badge').style.display='inline-block';$('connected-row').style.display='none'}
}
function openSettings(){$('url-input').value=scriptUrl;$('settings-modal').classList.add('open')}
function closeSettings(){$('settings-modal').classList.remove('open')}
$('settings-btn').addEventListener('click',openSettings);
$('no-sheet-badge').addEventListener('click',openSettings);
$('modal-close-btn').addEventListener('click',closeSettings);
$('settings-modal').addEventListener('click',e=>{if(e.target===$('settings-modal'))closeSettings()});
$('connect-btn').addEventListener('click',async()=>{const url=$('url-input').value.trim();if(!url)return;localStorage.setItem(SCRIPT_URL_KEY,url);scriptUrl=url;updateConnectionUI();closeSettings();setLoading(true);await fetchEntries();setLoading(false);showToast('Connected to Google Sheets!')});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchEntries(){
  if(!scriptUrl){renderGrid([]);$('list-title').textContent='All Issues (0)';return}
  setSyncing(true);
  try{
    const res=await fetch(scriptUrl+'?action=getAll');const data=await res.json();
    if(data.entries){allEntries=data.entries;populateFilterSelects();refreshIssues();}
    else throw new Error(data.error||'Failed');
  }catch(e){showToast('Could not reach Google Sheets. Check ‚öôÔ∏è','error');renderGrid([])}
  setSyncing(false);
}
async function apiPost(body){const res=await fetch(scriptUrl,{method:'POST',body:JSON.stringify(body)});return res.json()}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGrid(entries){
  const grid=$('entries-grid');
  if(!entries.length){
    grid.innerHTML=!scriptUrl?`<div class="empty"><span class="empty-icon">‚öôÔ∏è</span><p>No Google Sheet connected.<br><button class="btn-inline" onclick="openSettings()">Click here to connect one</button> ‚Äî free &amp; takes 5 min.</p></div>`:`<div class="empty"><span class="empty-icon">üí°</span><p>No issues found. Try clearing filters or <button class="btn-inline" onclick="startAdd()">log a new issue</button>.</p></div>`;return;
  }
  grid.innerHTML='<div class="grid">'+entries.map(cardHTML).join('')+'</div>';
  grid.querySelectorAll('.card').forEach(c=>c.addEventListener('click',()=>showDetail(c.dataset.id)));
  applyView();
}

function cardHTML(e){
  const steps=e.steps||[];
  const tools=e.tools?e.tools.split('||').map(t=>t.trim()).filter(Boolean):[];
  const commentCount=getComments(e.id).length;
  const meta=[
    e.location?`<span class="card-meta-item">üìç ${esc(e.location)}</span>`:'',
    e.date?`<span class="card-meta-item">üìÖ ${esc(e.date)}</span>`:'',
    e.reportedBy?`<span class="card-meta-item">üë§ ${esc(e.reportedBy)}</span>`:'',
    e.manufacturer?`<span class="card-meta-item">üè≠ ${esc(e.manufacturer)}</span>`:'',
    e.equipment?`<span class="card-meta-item">‚öôÔ∏è ${esc(e.equipment)}</span>`:'',
  ].join('');
  const preview=steps[0]?`<p class="card-preview">${esc(steps[0])}</p>`:'';
  const toolsLabel=tools.length?`<span class="card-tools">üîß ${esc(tools[0])}${tools.length>1?' +'+(tools.length-1):''}</span>`:'';
  const commentBadge=commentCount?`<span class="card-comment-badge">üí¨ ${commentCount}</span>`:'';
  return`<button class="card" data-id="${esc(e.id)}"><p class="card-issue">${esc(e.issue)}</p><div class="card-meta">${meta}</div>${preview}<div class="card-footer"><span class="card-tag">${steps.length} step${steps.length!==1?'s':''}</span>${toolsLabel}${commentBadge}</div></button>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('search-btn').addEventListener('click',doSearch);
$('search-input').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch()});
$('search-input').addEventListener('input',()=>{if(!$('search-input').value.trim())refreshIssues()});

function doSearch(){
  const q=$('search-input').value.trim().toLowerCase();if(!q)return;
  const r=allEntries.filter(e=>{
    const tools=e.tools?e.tools.split('||').map(t=>t.trim()):[];
    return(e.issue||'').toLowerCase().includes(q)||(e.steps||[]).some(s=>s.toLowerCase().includes(q))||(e.location||'').toLowerCase().includes(q)||tools.some(t=>t.toLowerCase().includes(q))||(e.manufacturer||'').toLowerCase().includes(q)||(e.equipment||'').toLowerCase().includes(q)||(e.reportedBy||'').toLowerCase().includes(q);
  });
  const sorted=applyFiltersAndSort(r);
  $('list-title').textContent=sorted.length+' result'+(sorted.length!==1?'s':'')+' for "'+q+'"';
  renderGrid(sorted);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startAdd(){
  ['add-issue','add-reported-by','add-links'].forEach(id=>$(id).value='');
  $('add-date').value='';
  addToolsSel=[];addMfrSel='';addEquipSel='';addLocSel='';
  $('add-mfr-value').value='';$('add-equip-value').value='';$('add-loc-value').value='';
  addToolsCombo.renderTags();addMfrCombo.renderLabel();addEquipCombo.renderLabel();addLocCombo.renderLabel();
  renderSteps('steps-container',['']);
  showView('add');
}
$('add-btn').addEventListener('click',startAdd);
$('add-back-btn').addEventListener('click',()=>showView('home'));
$('add-cancel-btn').addEventListener('click',()=>showView('home'));
$('add-step-btn').addEventListener('click',()=>addStepRow('steps-container'));

$('add-save-btn').addEventListener('click',async()=>{
  const issue=$('add-issue').value.trim();
  if(!issue){showToast('Please enter an issue description.','error');return}
  if(!scriptUrl){showToast('Connect a Google Sheet first via ‚öôÔ∏è','error');openSettings();return}
  $('add-save-btn').textContent='Saving‚Ä¶';$('add-save-btn').disabled=true;
  try{
    const res=await apiPost({action:'add',issue,location:addLocSel,date:$('add-date').value,reportedBy:$('add-reported-by').value.trim(),manufacturer:addMfrSel,equipment:addEquipSel,tools:addToolsSel.join(' || '),steps:getSteps('steps-container'),links:$('add-links').value.trim()});
    if(res.success){showToast('Issue logged to Google Sheets!');await fetchEntries();showView('home')}else throw new Error(res.error);
  }catch(e){showToast('Save failed: '+e.message,'error')}
  $('add-save-btn').textContent='Save to Google Sheets';$('add-save-btn').disabled=false;
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('edit-back-btn').addEventListener('click',()=>showDetail(currentDetailId));
$('edit-cancel-btn').addEventListener('click',()=>showDetail(currentDetailId));
$('edit-add-step-btn').addEventListener('click',()=>addStepRow('steps-container-edit'));

function startEdit(entry){
  $('edit-id').value=entry.id;$('edit-issue').value=entry.issue||'';$('edit-date').value=entry.date||'';$('edit-reported-by').value=entry.reportedBy||'';$('edit-links').value=entry.links||'';
  editToolsSel=(entry.tools||'').split('||').map(t=>t.trim()).filter(Boolean);editToolsCombo.renderTags();
  editMfrSel=entry.manufacturer||'';$('edit-mfr-value').value=editMfrSel;editMfrCombo.renderLabel();
  editEquipSel=entry.equipment||'';$('edit-equip-value').value=editEquipSel;editEquipCombo.renderLabel();
  editLocSel=entry.location||'';$('edit-loc-value').value=editLocSel;editLocCombo.renderLabel();
  renderSteps('steps-container-edit',entry.steps?.length?entry.steps:['']);showView('edit');
}

$('edit-save-btn').addEventListener('click',async()=>{
  const issue=$('edit-issue').value.trim();if(!issue){showToast('Issue description required.','error');return}
  $('edit-save-btn').textContent='Updating‚Ä¶';$('edit-save-btn').disabled=true;
  try{
    const res=await apiPost({action:'update',id:$('edit-id').value,issue,location:editLocSel,date:$('edit-date').value,reportedBy:$('edit-reported-by').value.trim(),manufacturer:editMfrSel,equipment:editEquipSel,tools:editToolsSel.join(' || '),steps:getSteps('steps-container-edit'),links:$('edit-links').value.trim()});
    if(res.success){showToast('Entry updated!');await fetchEntries();showDetail($('edit-id').value)}else throw new Error(res.error);
  }catch(e){showToast('Update failed: '+e.message,'error')}
  $('edit-save-btn').textContent='Update Entry';$('edit-save-btn').disabled=false;
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('detail-back-btn').addEventListener('click',()=>showView('home'));

function showDetail(id){
  const entry=allEntries.find(e=>e.id===id);if(!entry)return;
  currentDetailId=id;
  $('detail-title').textContent=entry.issue;
  $('detail-meta').innerHTML=[
    entry.location?`<span class="badge">üìç ${esc(entry.location)}</span>`:'',
    entry.date?`<span class="badge">üìÖ ${esc(entry.date)}</span>`:'',
    entry.reportedBy?`<span class="badge">üë§ ${esc(entry.reportedBy)}</span>`:'',
    entry.manufacturer?`<span class="badge">üè≠ ${esc(entry.manufacturer)}</span>`:'',
    entry.equipment?`<span class="badge">‚öôÔ∏è ${esc(entry.equipment)}</span>`:'',
  ].join('');
  const steps=entry.steps||[];
  if(steps.length){$('detail-steps').innerHTML=steps.map(s=>`<li>${esc(s)}</li>`).join('');$('detail-steps-sec').style.display='block'}else $('detail-steps-sec').style.display='none';
  const tools=entry.tools?entry.tools.split('||').map(t=>t.trim()).filter(Boolean):[];
  if(tools.length){$('detail-tools-badges').innerHTML=tools.map(t=>`<span class="badge badge-tool">üîß ${esc(t)}</span>`).join('');$('detail-tools-sec').style.display='block'}else $('detail-tools-sec').style.display='none';
  if(entry.links){$('detail-links').innerHTML=entry.links.split('\n').filter(Boolean).map(l=>`<div style="margin-bottom:4px"><a href="${esc(l.trim())}" target="_blank" rel="noopener">${esc(l.trim())}</a></div>`).join('');$('detail-links-sec').style.display='block'}else $('detail-links-sec').style.display='none';
  $('detail-created').textContent=entry.createdAt?'Logged: '+new Date(entry.createdAt).toLocaleString():'';
  $('detail-edit-btn').onclick=()=>startEdit(entry);
  $('detail-delete-btn').onclick=()=>handleDelete(id);
  $('detail-print-btn').onclick=()=>printEntry(entry);
  renderComments(id);setupCommentForm(id);
  showView('detail');
}

async function handleDelete(id){
  if(!confirm('Delete this entry? This cannot be undone.'))return;
  try{const res=await apiPost({action:'delete',id});if(res.success){delete commentsDB[id];saveComments();showToast('Entry deleted.');await fetchEntries();showView('home')}else throw new Error(res.error)}
  catch(e){showToast('Delete failed: '+e.message,'error')}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRINT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function printEntry(entry){
  const tools=entry.tools?entry.tools.split('||').map(t=>t.trim()).filter(Boolean):[];
  const steps=entry.steps||[];
  const comments=getComments(entry.id);
  const printArea=$('print-area');
  printArea.innerHTML=`
    <div class="detail-card" style="max-width:700px;margin:0 auto">
      <div style="font-size:11px;color:#999;margin-bottom:8px">LightFix DB ¬∑ Printed ${new Date().toLocaleString()}</div>
      <h2 class="detail-title" style="margin-bottom:12px">${esc(entry.issue)}</h2>
      <div class="meta-row">
        ${entry.location?`<span class="badge">üìç ${esc(entry.location)}</span>`:''}
        ${entry.date?`<span class="badge">üìÖ ${esc(entry.date)}</span>`:''}
        ${entry.reportedBy?`<span class="badge">üë§ ${esc(entry.reportedBy)}</span>`:''}
        ${entry.manufacturer?`<span class="badge">üè≠ ${esc(entry.manufacturer)}</span>`:''}
        ${entry.equipment?`<span class="badge">‚öôÔ∏è ${esc(entry.equipment)}</span>`:''}
      </div>
      ${steps.length?`<div class="detail-sec"><div class="detail-sec-title">Steps Taken</div><ol class="step-list">${steps.map(s=>`<li>${esc(s)}</li>`).join('')}</ol></div>`:''}
      ${tools.length?`<div class="detail-sec"><div class="detail-sec-title">Tools Used</div><div style="display:flex;flex-wrap:wrap;gap:6px">${tools.map(t=>`<span class="badge badge-tool">üîß ${esc(t)}</span>`).join('')}</div></div>`:''}
      ${entry.links?`<div class="detail-sec"><div class="detail-sec-title">Helpful Links</div>${entry.links.split('\n').filter(Boolean).map(l=>`<div>${esc(l.trim())}</div>`).join('')}</div>`:''}
      ${comments.length?`<div class="detail-sec"><div class="detail-sec-title">Comments & Notes (${comments.length})</div>${comments.map(c=>`<div style="border:1px solid #ccc;border-radius:6px;padding:8px 10px;margin-bottom:6px"><strong>${esc(c.author||'Anonymous')}</strong> <span style="color:#999;font-size:11px">${c.time?new Date(c.time).toLocaleString():''}</span><div style="margin-top:4px">${esc(c.text)}</div></div>`).join('')}</div>`:''}
      <div class="timestamps"><span>Logged: ${entry.createdAt?new Date(entry.createdAt).toLocaleString():''}</span></div>
    </div>`;
  window.print();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderComments(entryId){
  const comments=getComments(entryId);
  $('comment-count').textContent=comments.length;
  const list=$('comments-list');
  if(!comments.length){list.innerHTML='<div class="comments-empty">No comments yet. Be the first to add a note.</div>';return}
  list.innerHTML=comments.map((c,i)=>`<div class="comment-item"><div class="comment-header"><span class="comment-author">üë§ ${esc(c.author||'Anonymous')}</span><div style="display:flex;align-items:center;gap:8px"><span class="comment-time">${c.time?new Date(c.time).toLocaleString():''}</span><button class="comment-delete" data-idx="${i}" title="Delete">üóë</button></div></div><div class="comment-body">${esc(c.text)}</div></div>`).join('');
  list.querySelectorAll('.comment-delete').forEach(btn=>btn.addEventListener('click',()=>{if(!confirm('Delete this comment?'))return;commentsDB[entryId].splice(parseInt(btn.dataset.idx),1);saveComments();renderComments(entryId);showToast('Comment deleted.')}));
}

function setupCommentForm(entryId){
  const btn=$('comment-submit-btn');const newBtn=btn.cloneNode(true);btn.parentNode.replaceChild(newBtn,btn);
  newBtn.addEventListener('click',()=>{
    const author=$('comment-author').value.trim();const text=$('comment-text').value.trim();
    if(!text){showToast('Please write a comment first.','error');return}
    if(!commentsDB[entryId])commentsDB[entryId]=[];
    commentsDB[entryId].push({author:author||'Anonymous',text,time:new Date().toISOString()});
    saveComments();$('comment-text').value='';renderComments(entryId);showToast('Comment added!');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSteps(cid,steps){const c=$(cid);c.innerHTML='';steps.forEach((v,i)=>appendStepRow(cid,v,i+1))}
function addStepRow(cid){appendStepRow(cid,'',$(cid).querySelectorAll('.step-row').length+1)}
function appendStepRow(cid,val,n){const c=$(cid),row=document.createElement('div');row.className='step-row';row.innerHTML=`<span class="step-num">${n}</span><input class="inp step-inp" type="text" placeholder="Step ${n}‚Ä¶" value="${esc(val)}" style="flex:1"/><button type="button" class="step-remove">‚úï</button>`;row.querySelector('.step-remove').addEventListener('click',()=>{row.remove();renumber(cid)});c.appendChild(row)}
function renumber(cid){$(cid).querySelectorAll('.step-row').forEach((row,i)=>{row.querySelector('.step-num').textContent=i+1;row.querySelector('.step-inp').placeholder='Step '+(i+1)+'‚Ä¶'})}
function getSteps(cid){return Array.from($(cid).querySelectorAll('.step-inp')).map(i=>i.value.trim()).filter(Boolean)}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('logo-btn').addEventListener('click',()=>{
  $('search-input').value='';activeSort='newest';activeMfr='';activeLoc='';activeEquip='';
  $('sort-select').value='newest';$('filter-mfr').value='';$('filter-loc').value='';$('filter-equip').value='';
  updateFilterClearBtn();
  document.querySelectorAll('.btn-tab').forEach(b=>b.classList.remove('active'));
  document.querySelector('.btn-tab[data-tab="issues"]').classList.add('active');
  ['issues','tools','equipment','locations','manufacturers'].forEach(t=>$('tab-'+t).style.display='none');
  $('tab-issues').style.display='block';
  refreshIssues();showView('home');
});
$('refresh-btn').addEventListener('click',async()=>{setLoading(true);await fetchEntries();setLoading(false)});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let isLight = localStorage.getItem('lightfix-theme') === 'light';
function applyTheme(){
  document.body.classList.toggle('light', isLight);
  $('theme-btn').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  $('theme-btn').title = isLight ? 'Switch to dark mode (T)' : 'Switch to light mode (T)';
}
function toggleTheme(){
  isLight = !isLight;
  localStorage.setItem('lightfix-theme', isLight ? 'light' : 'dark');
  applyTheme();
}
$('theme-btn').addEventListener('click', toggleTheme);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW TOGGLE (expanded ‚Üî compact)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let isCompact = localStorage.getItem('lightfix-view') === 'compact';
function applyView(){
  const grid = document.querySelector('.grid');
  if(grid) grid.classList.toggle('compact', isCompact);
  $('view-toggle-btn').textContent = isCompact ? '‚äû' : '‚ò∞';
  $('view-toggle-btn').title = isCompact ? 'Switch to expanded view (V)' : 'Switch to compact view (V)';
}
function toggleView(){
  isCompact = !isCompact;
  localStorage.setItem('lightfix-view', isCompact ? 'compact' : 'expanded');
  applyView();
}
$('view-toggle-btn').addEventListener('click', toggleView);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD SHORTCUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let kbdHintVisible = localStorage.getItem('lightfix-kbd') !== 'hidden';
function applyKbdHint(){ $('kbd-hint').classList.toggle('visible', kbdHintVisible); }

document.addEventListener('keydown', e => {
  const tag = document.activeElement.tagName;
  const typing = ['INPUT','TEXTAREA','SELECT'].includes(tag);
  const modalOpen = document.querySelector('.modal-overlay.open');

  if(e.key === '?' && !typing){
    kbdHintVisible = !kbdHintVisible;
    localStorage.setItem('lightfix-kbd', kbdHintVisible ? 'shown' : 'hidden');
    applyKbdHint(); return;
  }
  if(modalOpen || typing) return;

  switch(e.key){
    case 'n': case 'N':
      e.preventDefault(); startAdd(); break;
    case 'r': case 'R':
      e.preventDefault(); setLoading(true); fetchEntries().then(()=>setLoading(false)); break;
    case 't': case 'T':
      toggleTheme(); break;
    case 'v': case 'V':
      toggleView(); break;
    case '/':
      e.preventDefault(); showView('home');
      document.querySelector('.btn-tab[data-tab="issues"]').click();
      setTimeout(()=>$('search-input').focus(), 50); break;
    case 'Escape':
      const active = document.querySelector('.view.active');
      if(!active) break;
      if(active.id==='view-detail') showView('home');
      else if(active.id==='view-edit') showDetail(currentDetailId);
      else if(active.id==='view-add') showView('home');
      break;
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  loadComments();updateConnectionUI();initCombos();wireDbButtons();renderDBs();
  applyTheme();applyKbdHint();
  showView('home');
  if(scriptUrl){setLoading(true);await fetchEntries();setLoading(false)}
  else{renderGrid([]);$('list-title').textContent='All Issues (0)'}
}
init();
</script>
</body>
</html>
